# ======================================================================================
#  Last Updated: 2025-12-03
#
#  Description:
#  This is the main CD workflow for the CARMA VIP Adaptor.
#  It orchestrates the build and deployment process for the CARMA VIP Adaptor service.
#
#  Triggers:
#  1. Automatic (`push`): Triggers automatically when code is merged to 'master' branch.
#  2. Manual (`workflow_dispatch`): Allows for manual deployments.
#     Optionally accepts a 7-character commit SHA.
#
# ======================================================================================

name: CD CARMA VIP Adaptor

# --- TRIGGERS -----------------------------------------------------------------------
on:
  # Triggers this workflow when code is merged to master branch
  push:
    branches: [master]
    paths:
      - "**.js"
      - "package*.json"
      - "Dockerfile"
      - ".github/workflows/cd-carma-vip-adaptor.yml"
      - ".github/workflows/build-template.yml"

  # manual trigger
  workflow_dispatch:
    inputs:
      short_merge_commit_sha:
        description: "Optional: Short merge commit SHA"
        required: false

# --- JOBS ---------------------------------------------------------------------------
jobs:
  # ------------------------------------------------------------------------------------
  #  Purpose: Determine the correct tag to be used for the build.
  #           - For push triggers: uses the 7-character commit SHA from the merge.
  #           - For manual triggers: uses the provided SHA, or 'manual' if none is provided.
  #  Outputs:
  #    - short_sha: The validated 7-character commit SHA or 'manual' for manual runs without SHA.
  # ------------------------------------------------------------------------------------
  prepare-build-params:
    runs-on: ubuntu-latest
    # This job runs for push events or manual dispatch
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    outputs:
      short_sha: ${{ steps.determine-sha-from-push.outputs.short_sha || steps.validate-manual-sha.outputs.short_sha }}
    steps:
      # This step handles the automated trigger from push to master
      - name: Extract Commit SHA from Push Event
        id: determine-sha-from-push
        if: github.event_name == 'push'
        run: |
          # The push event provides the exact commit SHA from the merge.
          COMMIT_SHA="${{ github.sha }}"
          echo "Merge commit SHA: $COMMIT_SHA"
          echo "short_sha=$(echo $COMMIT_SHA | cut -c1-7)" >> $GITHUB_OUTPUT

      # This step handles the manual trigger
      - name: Validate Manual Trigger SHA or Use 'manual'
        id: validate-manual-sha
        if: github.event_name == 'workflow_dispatch'
        run: |
          SHORT_SHA="${{ github.event.inputs.short_merge_commit_sha }}"
          if [[ -z "$SHORT_SHA" ]]; then
            SHORT_SHA="manual"
          elif [[ ! "$SHORT_SHA" =~ ^[a-fA-F0-9]{7}$ ]]; then
            echo "::error::SHA must be exactly 7 hexadecimal characters. Received: '$SHORT_SHA'"
            exit 1
          fi
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

  # ------------------------------------------------------------------------------------
  #  Job: build-and-deploy
  #  Purpose: Calls the reusable build workflow to build, publish, and scan the image.
  # ------------------------------------------------------------------------------------
  build-and-deploy:
    needs: prepare-build-params
    permissions:
      # Core repository and deployment access
      contents: read              # Read repository files and clone code
      actions: read              # Read workflow runs and job information for private repo access
      packages: write             # Push Docker images to container registry
      # Environment and security
      id-token: write             # Required for environment protection and OIDC
      security-events: write      # Upload security scan results (Trivy SARIF)
    uses: ./.github/workflows/build-template.yml
    with:
      EVENT_NAME: ${{ github.event_name }}
      IMAGE_CONTEXT: .
      IMAGE_FILE: ./Dockerfile
      IMAGE_NAME: carma-vip-adaptor
      REGISTRY: ${{ vars.OCP4_REGISTRY }}
      BRANCH: ${{ github.ref_name }}
      # Use the output from prepare-build-params job
      COMMIT_SHA: ${{ needs.prepare-build-params.outputs.short_sha }}
    secrets:
      REGISTRY_USER: ${{ secrets.OCP4_USERNAME }}
      REGISTRY_PASSWORD: ${{ secrets.OCP4_PASSWORD }}
